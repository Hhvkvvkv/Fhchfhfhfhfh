require "import"
import "android.widget.*"
import "android.view.*"
import "android.os.*"
import "java.io.*"
import "java.net.*"

function onCreate(savedInstanceState)
  activity.setTitle("تنزيل المجلد واستخراج الملف")
  local layout = LinearLayout(activity)
  layout.setOrientation(LinearLayout.VERTICAL)

  local btnDownloadFolder = Button(activity)
  btnDownloadFolder.setText("تنزيل المجلد واستخراج الملف")
  layout.addView(btnDownloadFolder)

  local scrollView = ScrollView(activity)
  local txtContent = TextView(activity)
  txtContent.setTextSize(16)
  scrollView.addView(txtContent)
  
  local scrollParams = LinearLayout.LayoutParams(-1, 0)
  scrollParams.weight = 1
  layout.addView(scrollView, scrollParams)

  activity.setContentView(layout)

  btnDownloadFolder.setOnClickListener{
    onClick = function(view)
      downloadFolderAndExtract(txtContent)
    end
  }
end

-- دالة لتحميل محتوى أي رابط كنص
function downloadUrlContent(urlStr)
  local content = ""
  local url = URL(urlStr)
  local connection = url.openConnection()
  connection.setConnectTimeout(15000)
  connection.setReadTimeout(15000)
  connection.connect()
  local inputStream = connection.getInputStream()
  local isr = InputStreamReader(inputStream, "UTF-8")
  local br = BufferedReader(isr)
  local line = br.readLine()
  while line do
    content = content .. line .. "\n"
    line = br.readLine()
  end
  br.close()
  isr.close()
  inputStream.close()
  return content
end

-- دالة لتحميل صفحة المجلد باستخدام الرابط، ثم استخراج معرف الملف الموجود بداخلها عبر pattern matching
function downloadFolderAndExtract(txtContent)
  Thread(Runnable{
    run = function()
      -- رابط مجلد جوجل درايف
      local folderUrl = "https://drive.google.com/drive/folders/1LVDfnX85Gc8EvKzIIdwipZkkezWnoWMS"
      local folderHtml = downloadUrlContent(folderUrl)
      
      -- محاولة استخراج معرف الملف باستخدام نمط يبحث عن "file/d/معرف_الملف/view"
      local fileId = string.match(folderHtml, "file/d/([^/]+)/view")
      
      if not fileId then
        activity.runOnUiThread(Runnable{
          run = function()
            Toast.makeText(activity, "لم يتم العثور على ملف داخل المجلد", Toast.LENGTH_SHORT).show()
          end
        })
        return
      end

      -- بناء رابط التنزيل المباشر للملف باستخدام المعرف المستخرج
      local fileDownloadUrl = "https://drive.google.com/uc?export=download&id=" .. fileId
      local fileContent = downloadUrlContent(fileDownloadUrl)
      
      activity.runOnUiThread(Runnable{
        run = function()
          txtContent.setText(fileContent)
          Toast.makeText(activity, "تم تنزيل الملف وعرض المحتوى", Toast.LENGTH_SHORT).show()
        end
      })
    end
  }).start()
end
